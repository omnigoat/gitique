 
  <!-- jj -->
  <script type="text/javascript" src="/javascripts/jj.js"></script>
  <script type="text/javascript" src="/javascripts/jaja.js"></script>
  
<style>
  html, body {
    position: absolute;
    bottom: 0px;
    top: 0px;
    left: 0px;
    right: 0px;
    margin: 0px;
    padding: 0px;
    border: none;
  }

  #simplemodal-container {
    background: white;
    -moz-box-shadow: 0px 0px 10px black;
    padding: 10px;
  }
  
  .floatingbox {
    -moz-box-shadow: 0px 0px 10px black;
  }
  
  #title {
    padding: 2px;
    margin: 10px;
  }
  
  #title span.title {
    font-size: 3em;
  }
  
  #title span.info {
    font-size: 1em;
    color: #aaaaaa;
    font-style: italic;
  }
  
  #critiques {
    float: left;
    width: 40%;
    overflow: hidden;
  }
  
    .critique {
      -moz-box-shadow: 0px 0px 10px black;
      margin: 10px;
      padding: 50px;
      width: 100%px;
    }
    
    .critique:hover {
      -moz-box-shadow: 0px 0px 10px blue;
    }
  
  #viewer-wrapper {
    float: right;
    width: 60%;
    height: 100%;
    overflow:hidden;
  }
  
  #viewer {
    margin: 10px 0px 10px 10px;
    -moz-box-shadow: 0px -0px 10px black;
  }
   
    #viewer-content-wrapper
    {
      position: relative;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }

      #mainpre {
        position: absolute;
        top: 0px;
        left: 0px;
      }
  
    #vsb {
      height: 100%;
    }
 
    #hsb {
      bottom: 0px;
    }

  table.coding-window {
    margin: 0;
    padding: 20px 0px 0px 20px;
    height: 100%;
    width: 100%;
  }
  
  #mainpre div.container {
    position: relative !important;
    overflow: hidden !important;
  }
  
  #mainpre div.container-wrapper {
    overflow: hidden !important;
    positiion: relative !important;
  }
  
  div.toolbar {
    display: none !important;
  }
  
</style>


<!--- ----------------------------------------------------
visible layout
----------------------------------------------------- --->

  <!-- title -->
  <div id="title">
    <span class='title'>Gitique</span><span class='info'>logged in as blah blah blah</span>
  </div>

  <!-- critiques -->
  <div id="critiques">
    Critiques <a href="javascript:go()">go</a>  
    <div class="critique">
      <span class="name"></span>
    </div>
  </div>

  <!-- "viewer" -->
  <div id="viewer-wrapper">
  <div id="viewer">
    <table class="coding-window">
      <tr>
        <td>
          <%= @repo.url %><br />
          <%= @branch + ":" + @filename %>
        </td>
        <td>
        </td>
      </tr>
      <tr style="width: 100%; height: 100%;">
        <td style="width: 100%">        
          <!-- actual code -->
          <div id="viewer-content-wrapper">
            <pre id="mainpre" class="brush: js;">
            </pre>
          </div>
        </td>
        <td>
          <!-- vertical scrollbar -->
          <div id="vsb"></div>
        </td>
      </tr>
      <tr>
        <td>
        	<!-- horizontal scrollbar -->
        	<div><div id="hsb"></div></div>
        </td>
        <td></td>
      </tr>
    </table>
  </div>
  </div>




<!-- hidden "scratch" buffer -->
<div id="shower" style="position:absolute; left:800px; visibility:hidden" class="hidden">
</div>

<!-- popup buffer -->
<div id="popupbuffer" style="display:none">
  Code:
  <pre id="bdpo" class="brush: js;">
  </pre>
  Comments:
  <textarea class="text_input text_area" name="t" id="t" cols="80" rows="4"></textarea>
  <a href="javascript:jkkj()">Ok</a>
</div>






<script type="text/javascript">
  window.repo_id = <%= @repo.id.to_s %>;
  window.branch = "<%= @branch %>";
  window.filename = "<%= @filename %>";
  window.total_lines = <%= @total_lines %>;
  
  
  $(window).resize(function() {
    //$('#critiques').height($('body').height() - $('#title').height());
    //$('#viewer').height($('body').height() - $('#title').height());
    $('#critiques').height($(window).height() - $('#critiques').position().top);
    $('#viewer-wrapper').height($(window).height() - $('#viewer-wrapper').position().top);
    $('#viewer').height($('#viewer-wrapper').height() - 10);
  });

  
  $(document).ready(function(){
    $(window).trigger('resize');
  });
  
  $(function() {
    $.getJSON('/critiques/get_all', {"repo_id": repo_id, "branch": branch, "filename": filename}, function(data) {
      //console.log(data[0].comments);
      //console.log(data.length);
      
      var directive = {
        'div.critique':{
          'critique <- critiques':{
            'span.name': 'critique.comments'
          }
        }
      };
      
      $('#critiques').render({critiques: data}, directive);
    });
  });
  
  function jkkj()
  {
    var $lines = $('#mainpre div.highlighted');
    if ($lines.length == 0) {
      alert("you haven't written anything!");
      return;
    }
    
    $.post(
      "/critiques/add",
      {lines: [parseInt($lines.first().index()), parseInt($lines.last().index())], comments: $('#t')[0].value},
      function(msg) {
        alert(msg);
      }
    );
  }
  
  //jaja.scrollbar($("#blah"));

  document.body.style.overflow = 'hidden';
  jj.sh.selected_highlighters = "#mainpre .syntaxhighlighter";
  
  SyntaxHighlighter.highlight();
  
  
  $('#viewer').mousewheel(function(event, delta) {
    var $vsb = $('#vsb');
    $vsb.slider("value", $vsb.slider("value") + delta * 3);
    $vsb.slider('option', 'slide').call($vsb, event, {handle: $vsb.slider('widget'), value: $vsb.slider('value')});
    event.preventDefault();
  });
  
  
  function go()
  {
    $('#popupbuffer div.container').children().remove();
    $('#popupbuffer td.gutter').children().remove();
          
    $("td.gutter div.highlighted").clone().toggle().removeClass('highlighted').appendTo($('#popupbuffer td.gutter'));
    $("div.container div.highlighted").clone().toggle().removeClass('highlighted').appendTo($('#popupbuffer div.container'));
    
    $("#popupbuffer").modal(
      {
        persist: true,
        
        opacity: 66,
        
        overlayCss:{
          backgroundColor: '#ffffff'
        },
        
        onOpen: function(dialog) {
          dialog.overlay.fadeIn('fast');
          dialog.container.fadeIn('fast');
          dialog.data.fadeIn('fast');
        },
        
        onClose: function(dialog) {
          dialog.overlay.fadeOut('fast');
          dialog.container.fadeOut('fast');
          dialog.data.fadeOut('fast');
          $.modal.close();
        }
      }
    );
  }
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  //=====================================================================
  // return selected text
  //=====================================================================
  function selection(){
    var t = '';
    if (window.getSelection) {
      t = window.getSelection();
    }
    else if (document.getSelection) {
      t = document.getSelection();
    }
    else if (document.selection) {
      t = document.selection.createRange().text;
    }
    return t;
  }
  
  //=====================================================================
  // clear selected text
  //=====================================================================
  function clear_selection() {
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
    }
    else {
      document.selection.clear();
    }
  }
  
  
  
  
  
  
  
</script>


